@using DataLayer.Repositories.Factory
@using DataLayer.Models
@{
    ViewBag.Title = "Home";

    SelectList ddlCities = new SelectList(
            items: (RepoFactory.GetRepo()).LoadCities(),
            dataTextField: "Name",
            dataValueField: "Id"
        );


    IList<SelectListItem> ddlStatusItems = new List<SelectListItem>();

    ddlStatusItems.Add(new SelectListItem { Text = "All apartments", Value = "all", Selected = true });
    ddlStatusItems.Add(new SelectListItem { Text = "Avaliable apartments", Value = "avaliable"});
    ddlStatusItems.Add(new SelectListItem { Text = "Unavaliable apartments", Value = "unavaliable" });

    SelectList ddlStatusSource = new SelectList(ddlStatusItems, "Value", "Text");


    IList<SelectListItem> ddlFilterItems = new List<SelectListItem>();

    ddlFilterItems.Add(new SelectListItem { Text = "Lowest price", Value = "PLH", Selected = true });
    ddlFilterItems.Add(new SelectListItem { Text = "Highest price", Value = "PHL" });
    ddlFilterItems.Add(new SelectListItem { Text = "Least rooms", Value = "RLH" });
    ddlFilterItems.Add(new SelectListItem { Text = "Most rooms", Value = "RHL" });
    ddlFilterItems.Add(new SelectListItem { Text = "Least space", Value = "SLH" });
    ddlFilterItems.Add(new SelectListItem { Text = "Most space", Value = "SHL" });

    SelectList ddlFiltersSource = new SelectList(ddlFilterItems, "Value", "Text");
}

<div class="container">
    <div class="col-sm mb-4">
        <div class="row mt-3">
            <div class="col-sm">
                @Html.TextBox(name: "Search", value: "", htmlAttributes: new { @class = "form-control", placeholder = "Search apartment..." })
            </div>
            <div class="col-sm">
                @Html.DropDownList(optionLabel: "Any city", selectList: ddlCities, name: "CityId", htmlAttributes: new { @class = "form-control", id = "cityDropDownList" })
            </div>
            <div class="col-sm">
                @Html.DropDownList(optionLabel: null, selectList: ddlStatusSource, name: "StatusId", htmlAttributes: new { @class = "form-control", id = "statusDropDownList" })
            </div>
            <div class="col-sm">
                @Html.DropDownList(optionLabel: null, selectList: ddlFiltersSource, name: "FilterCode", htmlAttributes: new { @class = "form-control", id = "filterDropDownList" })
            </div>
            <div class="col-md-auto">
                <button type="button" class="btn btn-custom" id="findButton">
                    Search
                </button>
            </div>
        </div>
    </div>

    <div class="col-sm apartments_container">
    </div>

</div>

@section scripts{
    <script>
        $("#filterDropDownList").val("PLH");

        $("#statusDropDownList").val("all");

        $("#cityDropDownList, #statusDropDownList, #filterDropDownList").each(function () {
            $(this).change(function () {
                loadApartmentListPartialViewAjax();
            });
        });

        $("#Search").autocomplete({
            source: '@Url.Action(actionName: "GetApartmentNames", controllerName: "Ajax")',
            minLength: 2,
            select: function (e, ui) {
                e.preventDefault();
                console.log(ui);
                var clickedName = ui.item.label;
                $(this).val(clickedName);
                return false;
            }
        });

        $(document).ready(function () {
            loadApartmentListPartialViewAjax();
        });

        $("#findButton").click(function () {
            loadApartmentListPartialViewAjax();
        });

        $('body').keypress(function (event) {
            var keycode = (event.keyCode ? event.keyCode : event.which);
            if (keycode == '13') {
                loadApartmentListPartialViewAjax();
            }
        });

        function loadApartmentListPartialViewAjax() {
            $.ajax({
                url: `/Home/LoadApartmentListPartialView/?Search=${$("#Search").val()}&CityId=${$("#cityDropDownList").val()}&StatusId=${$("#statusDropDownList").val()}&FilterCode=${$("#filterDropDownList").val()}`,
                success: function (partialView) {
                    $(".apartments_container").html("")
                    $(".apartments_container").append(partialView);
                }
            });
        }
    </script>
}