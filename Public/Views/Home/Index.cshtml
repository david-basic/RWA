@using DataLayer.Repositories.Factory
@using DataLayer.Models
@{
    ViewBag.Title = "Home";

    SelectList ddlCities = new SelectList(
            items: (RepoFactory.GetRepo()).LoadCities(),
            dataTextField: "Name",
            dataValueField: "Id"
        );

    IList<SelectListItem> ddlFilterItems = new List<SelectListItem>();

    ddlFilterItems.Add(new SelectListItem { Text = "Lowest price", Value = "PLH" });
    ddlFilterItems.Add(new SelectListItem { Text = "Highest price", Value = "PHL" });
    ddlFilterItems.Add(new SelectListItem { Text = "Least rooms", Value = "RLH" });
    ddlFilterItems.Add(new SelectListItem { Text = "Most rooms", Value = "RHL" });
    ddlFilterItems.Add(new SelectListItem { Text = "Least space", Value = "SLH" });
    ddlFilterItems.Add(new SelectListItem { Text = "Most space", Value = "SHL", Selected = true });

    SelectList ddlFiltersSource = new SelectList(ddlFilterItems, "Value", "Text");

    IList<SelectListItem> ddlStatusItems = new List<SelectListItem>();

    ddlStatusItems.Add(new SelectListItem { Text = "All apartments", Value = "all" });
    ddlStatusItems.Add(new SelectListItem { Text = "Available apartments", Value = "available", Selected = true });
    ddlStatusItems.Add(new SelectListItem { Text = "Unavailable apartments", Value = "unavaliable" });

    SelectList ddlStatusSource = new SelectList(ddlStatusItems, "Value", "Text");
}

<div class="container">
    <div class="col-sm mb-4">
        <div class="row mt-3">
            <div class="col-sm">
                @Html.TextBox(name: "Search", value: "", htmlAttributes: new { @class = "form-control", placeholder = "Search apartment..." })
            </div>

            <div class="col-sm">
                @Html.DropDownList(optionLabel: "Any city", selectList: ddlCities, name: "CityId", htmlAttributes: new { @class = "form-control", id = "cityddl" })
            </div>

            <div class="col-sm">
                @Html.DropDownList(optionLabel: null, selectList: ddlStatusSource, name: "StatusId", htmlAttributes: new { @class = "form-control", id = "statusddl" })
            </div>

            <div class="col-sm">
                @Html.DropDownList(optionLabel: null, selectList: ddlFiltersSource, name: "FilterCode", htmlAttributes: new { @class = "form-control", id = "filterddl" })
            </div>

            <div class="col-md-auto">
                <button type="button" class="btn btn-custom" id="btnSearch">Search</button>
            </div>
        </div>

        <div class="col-sm draw_apartments">
        </div>
    </div>
</div>

@section scripts{
    <script>
        $("#filterddl").val("SHL");

        $("#statusddl").val("available");

        $("#cityddl, #statusddl, #filterddl").each(function () {
            $(this).change(function () {
                loadApartmentListPartialViewAjax();
            });
        });

        $("#Search").autocomplete({
            source: '@Url.Action(actionName: "GetApartmentNames", controllerName: "Ajax")',
            minLength: 2,
            select: function (e, ui) {
                e.preventDefault();
                console.log(ui);
                var clickedName = ui.item.label;
                $(this).val(clickedName);
                return false;
            }
        });

        $(document).ready(function () {
            loadApartmentListPartialViewAjax();
        });

        $("#btnSearch").click(function () {
            loadApartmentListPartialViewAjax();
        });

        function loadApartmentListPartialViewAjax() {
            $.ajax({
                method: 'GET',
                url: `/Home/LoadApartmentListPartialView/?Search=${$("#Search").val()}&CityId=${$("#cityddl").val()}&StatusId=${$("#statusddl").val()}&FilterCode=${$("#filterddl").val()}`,
                success: function (partialView) {
                    $(".draw_apartments").fadeIn(500);
                    $(".draw_apartments").html("");
                    $(".draw_apartments").append(partialView);
                }
            });
        }
    </script>
}
